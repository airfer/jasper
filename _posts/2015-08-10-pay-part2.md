---
layout: post
cover: 'assets/images/new-pic-10.jpg'
title:  支付网关之场景支付
date:   2015-08-10 20:19:00
tags:   pay
subclass: 'post tag-test tag-content'
categories: 'casper'
navigation: True
logo: 'assets/images/ghost.png'
---


<h4>前言</h4>
在了解基本的支付网关逻辑数据库的设计原理之后，就可将所学到的知识用于实际的场景支付测试中
不同的支付场景，支付的逻辑也迥然不同。常见的场景支付有普通的网关交易，如用户在线购物；还有如
商户现金红包派发、优惠券组合支付、个人钱包充值消费退回、优惠券派发等等。不同的支付场景下理解支付的
业务逻辑最为关键，只有理解了业务逻辑，才能更好的明白测试的点在什么地方。

---

下面就以普通的网关交易为例子来阐述整个支付逻辑的过程：

###一、支付逻辑框架图

![](\images\pay1.png "支付逻辑框架图")

上述图可以很好的将支付从前端到后端的逻辑表述清楚，从图中可以看出整个支付逻辑可以分成三块
用户、商户、支付网关。每个部分都有自己独立的逻辑结构，现就逻辑结构进行分析：

+ 用户商户之间：用户在选购完商品，然后在商户服务器生成相关的订单，点击“去支付”后，会跳转到
支付网关的相关相关页面，在这个页面中用户可以选择相关的银行，或者是第三方支付比如支付宝。

+ 商户与支付网关之间：用户在支付网关完成相关支付，在支付完成后会跳转到商户定义的某个页面（支付
成功或者支付失败的返回页面会不同）。与此同时支付网关服务器会通知商户服务器，这笔订单是否成功，商户
服务器在收到确认通知后，会向支付网关服务器发送一个确认报文，确认收到通知信息。

+ **说明**：不同的网关支付，其实现方案也是有所差别，有的网关服务器并非在支付完成后向商户服务器发送报文，而是
需要商户服务器主动发送报文请求进行询问，类似于Tcp/Ip协议的三次握手。

+ 商户与用户之间：商户与用户之间的信息交互是将银行返回的支付结果以一种更加人性化的方式给用户呈现，
支付成功的话，可能会有链接可以使用户点击跳转查看订单详情。如果失败则可能会给用户提示此次支付失败的原因。

###二、支付网关注册逻辑图
![](\images\gatewayRegister.jpg "网关交易注册")

网关交易注册描述的是在支付进行时，支付网关前端与支付网关后台交互的场景。商户服务器将订单的相关信息包括订单号、支付金额等信息发送到支付网关前端，支付网关前端服务器抽取这些信息，并将这些信息组合成交易注册报文发送给网关支付后台服务器。网关支付后台服务器接收到注册报文后将做以下操作：

+ 首先是支付网关服务*GatewayServer*接收报文请求信息，并完成分发。

+ 如果判断判断这是一笔交易，将会调用*TransServer*服务。*TtransSer*服务将完成一系列数据表的记账操作。

+ 最后*TransServer*服务完成后将重新回到网关*GatewayServer*服务处，并完成核心网关的记账操作，最终记账完成。

###三、支付网关更新逻辑图
![](\images\gatewayUpdate.jpg "网关交易更新")


*网关交易更新*描述的在支付完成后，支付网关前端与支付网关服务器交互的场景。支付网关前端在获知银行返回的支付
结果后，将银行返回的信息包括支付的单号、成功后的银行返回单号等，组成更新报文并将报文发送到支付网关后台
服务器。支付网关后台服务器在完成一系列的记账操作后结束此次交易。网关注册与网关更新有一些区别：

+ 信息的来源不同。注册信息来源于商户服务器发送的信息，而更新来源于银行返回的信息。
   
+ 数据表的更新不同。以网关交易为例，注册的时候并不涉及到账户资金的变动，也就是说tAccounts表中的数据
并不会发生变化，但是在网关交易更新时，会根据银行返回的结果来变更账户的余额信息。

+ 需要注意的时，每次对交易表、收款表、账户表进行变动的时候都会产生相关的流水变化，便于查账。

---

###四、总结

本章以网关交易注册更新为例，对一般情形下的支付流程进行了简要的总结，在最后一章中将对支付中的一些概念进行整理。
