---
layout: post
cover: 'assets/images/new-pic-8.jpg'
title:  支付网关逻辑之特殊场景
date:   2015-08-12 18:19:00
tags:   pay
subclass: 'post tag-test tag-content'
categories: 'casper'
navigation: True
logo: 'assets/images/ghost.png'
---

<h4>前言</h4>
在支付的过程中，很多时候会有特殊的场景出现，现有的支付系统必须能够做到对支付的异常状况进行处理。
在这篇文章里，将对一些特殊的情况进行说明。

###一、对账
对账的目的就是核对账目的准确性，保证出现错误的订单可以在对账的过程中被找到，完成对账的步骤如下：

+ 内部对账过程。内部对账其实是一种数据信息收集的过程，如果收集的是付款信息，那么进行的是付款对账；
如果收集的是收款信息，那么进行的就是收款对账；根据信息收集类型的不同，对账也就不同

+ 上传文件解析。内部对账结束后，将在数据库中生成内部对账的信息数据表，这些信息存储在数据库中。对账肯定
是两方数据，一方数据为本身支付平台的数据；而另一方则为银行返回的对账文件。在这个阶段需要对银行返回的对账
文件进行解析，并获取到对账所需的相关信息。完成这个过程后，同样在数据库中会生成相关的数据信息。

+ 外部对账过程。在收集完内部数据，并完成对银行返回的对账文件的解析后，就具备了外部对账的基础。外部对账
程序将就同一订单号的交易数据在内部对账信息以及银行对账文件信息进行一一比对。所有的订单信息对比完后，对账的
过程也就结束了。

+ 对账结果说明。对账完成后，对账结果正确的数据放入对平表中，而对账失败的数据则放入对差表中。当对差表中有数据时
可能需要根据情况再行处理。

###二、掉单
交易掉单实质是在银行与支付平台之间出现数据不同步。    

掉单的场景发生如下：客户银行卡中的钱已经被扣除，但是银行或者第三方支付机构返回信息给我们说，此笔付款没有成功。由于客户在平台的订单为未支付，所以此时需要补单的操作。

+ 补单操作实际上是一个加款的动作
+ 实际场景中，发生补单并不是十分多见


###三、退票
退票的场景是多数发生在用户提现的情形下，当然也会发生在向用户付款的其他情形。用户提现时，用户的银行卡信息不对，或者
是向用户退款时，用户的银行卡不可用，这个场景下就需要退票。

+ 退票场景出现在，商户钱已被扣除，但是向用户支付时出现错误的场景
+ 已有场景包括提现、退款、基金赎回等场景


---

###三、总结

本章对支付系统的中对账以及掉单、退票进行了阐述，具体测试操作还要根据实际情况而定。
